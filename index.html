<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ACONFEX · MSP ULTRA-LITE</title>
<meta name="theme-color" content="#0f172a" />
<style>
:root{
  --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#38bdf8;
  --border:#1f2937; --chip:#0b3b54;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.wrap{max-width:1000px;margin:0 auto;padding:14px}
h1{margin:0;font-size:18px;letter-spacing:.3px}
.subtitle{color:var(--muted);font-size:12px}
.grid{display:grid;gap:14px}
@media(min-width:900px){.grid{grid-template-columns:370px 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a1324;color:var(--text);font-size:14px}
input[type=date]{color-scheme:dark}
textarea{min-height:88px;resize:vertical}
button{cursor:pointer;border-color:#0b2440;background:#0b2440}
button:hover{background:#0c3055}
.row{display:flex;gap:10px}.row>*{flex:1}
.docs{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){.docs{grid-template-columns:1fr 1fr}}
.docbox{border:1px dashed #27445f;border-radius:12px;padding:10px;background:#0b162a}
.dochead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.docname{font-weight:600}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;color:#bfeaff}
.chip.ok{background:rgba(34,197,94,.15);color:#bbf7d0}
.chip.ok::before{content:"✓ ";font-weight:700}
.chip.miss{background:rgba(239,68,68,.15);color:#fecaca}
.list-empty{border:1px dashed #234;border-radius:12px;padding:12px;color:#9fb3c8;background:#0b162a}
.record{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0a1324}
.light{width:12px;height:12px;border-radius:999px}
.light.green{background:var(--ok)}.light.yellow{background:var(--warn)}.light.red{background:var(--bad)}
.rec-head{display:flex;gap:8px;flex-wrap:wrap}
.rec-title{font-weight:700}
.muted{color:var(--muted)}
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-ghost{background:#091125;border-color:#1a2c48}
.help{font-size:12px;color:#a8c1d9}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#081122;border:1px solid #263850;border-radius:6px;padding:1px 6px}
.footer{color:#92a7be;font-size:12px;margin-top:4px}
.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#0b2a3f;color:#d8f0ff;border:1px solid #1d4763;padding:10px 14px;border-radius:10px;display:none}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div>
      <h1>ACONFEX · MSP ULTRA-LITE</h1>
      <div class="subtitle">Una sola página, datos guardados en tu teléfono (sin servidores)</div>
    </div>
    <div class="row" style="min-width:320px;align-items:center">
      <label for="weekSelect" class="muted" style="min-width:120px">Semana (vista)</label>
      <select id="weekSelect" title="Filtra la lista por semana"></select>
      <button id="newBtn" title="Nuevo contenedor">+ Nuevo</button>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- Formulario -->
  <section class="card" id="formCard">
    <h3 style="margin:0 0 10px">Contenedor</h3>
    <div class="row">
      <div>
        <label>Semana (del contenedor)</label>
        <select id="f_week"></select>
      </div>
      <div>
        <label>CNTR (ej. MAEU1234567)</label>
        <input id="f_cntr" placeholder="MAEU1234567" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Cliente</label>
        <input id="f_cliente" placeholder="Cliente" />
      </div>
      <div>
        <label>Destino</label>
        <input id="f_destino" placeholder="Ciudad/País" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>ETD (salida)</label>
        <input id="f_etd" type="date" />
      </div>
      <div>
        <label>Notas</label>
        <input id="f_notas" placeholder="Notas breves" />
      </div>
    </div>

    <label style="margin-top:12px">Documentos (PDF/Imagen)</label>
    <div class="docs">
      <div class="docbox" data-doctype="BL">
        <div class="dochead"><span class="docname">BL</span><span class="chip miss" id="state_BL">faltante</span></div>
        <input type="file" accept="application/pdf,image/*" data-file="BL" />
        <div class="help" id="info_BL"></div>
      </div>

      <div class="docbox" data-doctype="FACT">
        <div class="dochead"><span class="docname">Factura (Invoice)</span><span class="chip miss" id="state_FACT">faltante</span></div>
        <input type="file" accept="application/pdf,image/*" data-file="FACT" />
        <div class="help" id="info_FACT"></div>
      </div>

      <div class="docbox" data-doctype="PACKING">
        <div class="dochead"><span class="docname">Packing List</span><span class="chip miss" id="state_PACKING">faltante</span></div>
        <input type="file" accept="application/pdf,image/*" data-file="PACKING" />
        <div class="help" id="info_PACKING"></div>
      </div>

      <div class="docbox" data-doctype="FITO">
        <div class="dochead"><span class="docname">Fitosanitario</span><span class="chip miss" id="state_FITO">faltante</span></div>
        <input type="file" accept="application/pdf,image/*" data-file="FITO" />
        <div class="help" id="info_FITO"></div>
      </div>

      <div class="docbox" data-doctype="SEGURO">
        <div class="dochead"><span class="docname">Seguro</span><span class="chip miss" id="state_SEGURO">faltante</span></div>
        <input type="file" accept="application/pdf,image/*" data-file="SEGURO" />
        <div class="help" id="info_SEGURO"></div>
      </div>

      <div class="docbox" data-doctype="LOGGER">
        <div class="dochead"><span class="docname">Datalogger / Temperatura</span><span class="chip miss" id="state_LOGGER">faltante</span></div>
        <input type="file" accept="application/pdf,image/*,.csv" data-file="LOGGER" />
        <div class="help" id="info_LOGGER"></div>
      </div>

      <div class="docbox" data-doctype="OTROS">
        <div class="dochead"><span class="docname">Otros (PDF/PNG/JPG)</span><span class="chip" id="state_OTROS">0 adjuntos</span></div>
        <input type="file" accept="application/pdf,image/*" multiple data-file="OTROS" />
        <div class="help" id="info_OTROS"></div>
      </div>
    </div>

    <div class="actions">
      <button id="saveBtn">Guardar</button>
      <button id="pdfBtn">PDF unificado</button>
      <button id="shareBtn">Compartir PDF</button>
      <button id="newClearBtn" class="btn-ghost">Limpiar</button>
      <button id="deleteBtn" class="btn-ghost">Eliminar</button>
    </div>

    <div class="footer">Los documentos se guardan <b>localmente</b> en tu dispositivo (IndexedDB). No se suben a ningún servidor.</div>

    <div class="actions" style="margin-top:12px">
      <button id="exportBtn" class="btn-ghost">Respaldar (Exportar JSON)</button>
      <label for="importInput" class="btn-ghost" style="display:inline-block;text-align:center;cursor:pointer">Restaurar (Importar JSON)</label>
      <input id="importInput" type="file" accept="application/json" style="display:none" />
    </div>
  </section>

  <!-- Lista por semana -->
  <section class="card">
    <h3 style="margin:0 0 10px">Semana <span id="wkTitle">01</span> · Contenedores</h3>
    <div id="list"></div>
    <div id="empty" class="list-empty" style="display:none">Aún no hay contenedores esta semana. Pulsa <span class="kbd">+ Nuevo</span> para crear uno.</div>
  </section>
</main>

<div class="toast" id="toast"></div>

<!-- pdf-lib -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
/*************** Utils ***************/
const $ = (q)=>document.querySelector(q);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }
function weekOptions(sel){ sel.innerHTML=''; for(let i=1;i<=52;i++){ const op=document.createElement('option'); op.value=String(i).padStart(2,'0'); op.textContent='Semana '+String(i).padStart(2,'0'); sel.appendChild(op);} }

/*************** Storage (IndexedDB con fallback en memoria) ***************/
let db=null, useMemory=false;
let memRecords=new Map(), memFiles=new Map();

function openDB(){
  return new Promise((resolve,reject)=>{
    if(!('indexedDB' in window)) return reject(new Error('IndexedDB no soportado'));
    const req = indexedDB.open('aconfexDB', 1);
    req.onupgradeneeded = (e)=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('records')) d.createObjectStore('records',{keyPath:'id'});
      if(!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'fileId'});
    };
    req.onsuccess = ()=>{ db=req.result; resolve(); };
    req.onerror = ()=>reject(req.error);
  });
}
function tx(store,mode='readonly'){ return db.transaction(store,mode).objectStore(store); }

let saveRecord = async (rec)=>{ await new Promise((res,rej)=>{ const r=tx('records','readwrite').put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error); }); };
let getRecord  = async (id)=> await new Promise((res,rej)=>{ const r=tx('records').get(id); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
let deleteRecord = async (id)=>{ await new Promise((res,rej)=>{ const r=tx('records','readwrite').delete(id); r.onsuccess=res; r.onerror=()=>rej(r.error); }); const all=await getAllFilesFor(id); for(const f of all){ await new Promise((res,rej)=>{ const r=tx('files','readwrite').delete(f.fileId); r.onsuccess=res; r.onerror=()=>rej(r.error); }); } };
let getWeekRecords = async (week)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('records').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ if(String(c.value.week)===String(week)) out.push(c.value); c.continue(); } else res(out.sort((a,b)=>a.cntr.localeCompare(b.cntr))); }; req.onerror=()=>rej(req.error); });
let saveFile = async (id,docType,file)=>{ const key = (docType==='OTROS') ? `${id}:OTROS:${Date.now()}:${file.name}` : `${id}:${docType}`; const payload={fileId:key,id,docType,name:file.name,type:file.type,ts:Date.now()}; payload.blob=await file.arrayBuffer(); await new Promise((res,rej)=>{ const r=tx('files','readwrite').put(payload); r.onsuccess=res; r.onerror=()=>rej(r.error); }); };
let getFile  = async (id,docType)=> await new Promise((res,rej)=>{ const r=tx('files').get(`${id}:${docType}`); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
let getOtros = async (id)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('files').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ const v=c.value; if(v.id===id && v.docType==='OTROS') out.push(v); c.continue(); } else res(out); }; req.onerror=()=>rej(req.error); });
let getAllFilesFor = async (id)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('files').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ if(c.value.id===id) out.push(c.value); c.continue(); } else res(out); }; req.onerror=()=>rej(req.error); });

function enableMemory(){
  useMemory=true;
  saveRecord = async (rec)=>{ memRecords.set(rec.id, rec); };
  getRecord  = async (id)=> memRecords.get(id)||null;
  deleteRecord = async (id)=>{ memRecords.delete(id); for(const k of [...memFiles.keys()]) if(k.startsWith(id+':')) memFiles.delete(k); };
  getWeekRecords = async (week)=> [...memRecords.values()].filter(r=>String(r.week)===String(week)).sort((a,b)=>a.cntr.localeCompare(b.cntr));
  saveFile = async (id,docType,file)=>{ const key = (docType==='OTROS') ? `${id}:OTROS:${Date.now()}:${file.name}` : `${id}:${docType}`; const ab = await file.arrayBuffer(); memFiles.set(key,{fileId:key,id,docType,name:file.name,type:file.type,ts:Date.now(),blob:ab}); };
  getFile  = async (id,docType)=> memFiles.get(`${id}:${docType}`)||null;
  getOtros = async (id)=> [...memFiles.values()].filter(v=>v.id===id && v.docType==='OTROS');
  getAllFilesFor = async (id)=> [...memFiles.values()].filter(v=>v.id===id);
}

/*************** UI / Estado ***************/
function lightFor(rec){
  const hasBL=!!rec.files.BL, hasFITO=!!rec.files.FITO, hasSEGURO=!!rec.files.SEGURO;
  const n=[hasBL,hasFITO,hasSEGURO].filter(Boolean).length;
  if(n>=3) return 'green'; if(n>=2) return 'yellow'; return 'red';
}
let currentWeek='01', currentId=null;

async function inflateRecord(base){
  const id=base.id; const files={};
  for(const k of ['BL','FACT','PACKING','FITO','SEGURO','LOGGER']){
    const f = await getFile(id,k); files[k]=!!f;
  }
  const otros = await getOtros(id); files.OTROS = otros.length;
  return {...base, files};
}
function updateDocState(k, ok, info){
  const chip = document.getElementById('state_'+k); if(!chip) return;
  chip.className = 'chip ' + (ok? 'ok':'miss');
  chip.innerHTML = ok ? 'cargado' : 'faltante';
  const inf = document.getElementById('info_'+k); if(inf) inf.textContent = info||'';
}
function updateOtrosState(n, names){
  const chip = document.getElementById('state_OTROS');
  if(n>0){ chip.className='chip ok'; chip.innerHTML=(n||0)+' adjuntos'; }
  else { chip.className='chip'; chip.textContent='0 adjuntos'; }
  const inf = document.getElementById('info_OTROS'); if(names&&names.length) inf.textContent=names.join(', '); else if(inf) inf.textContent='';
}
function clearForm(){
  currentId=null; $('#f_cntr').value=''; $('#f_cliente').value=''; $('#f_destino').value=''; $('#f_etd').value=''; $('#f_notas').value='';
  for(const k of ['BL','FACT','PACKING','FITO','SEGURO','LOGGER']) updateDocState(k,false,''); updateOtrosState(0,[]);
}
function loadIntoForm(rec){
  currentId=rec.id; $('#f_week').value=rec.week; $('#f_cntr').value=rec.cntr; $('#f_cliente').value=rec.cliente||''; $('#f_destino').value=rec.destino||''; $('#f_etd').value=rec.etd||''; $('#f_notas').value=rec.notas||'';
  inflateRecord(rec).then(r=>{ for(const k of ['BL','FACT','PACKING','FITO','SEGURO','LOGGER']) updateDocState(k,r.files[k],r.files[k]?'cargado':''); updateOtrosState(r.files.OTROS,[]); });
}
async function refreshList(){
  const list=$('#list'); list.innerHTML='';
  const data = await getWeekRecords(currentWeek);
  if(!data.length){ $('#empty').style.display='block'; $('#wkTitle').textContent=currentWeek; return; }
  $('#empty').style.display='none'; $('#wkTitle').textContent=currentWeek;
  for(const r of data){
    const rec = await inflateRecord(r);
    const item=document.createElement('div'); item.className='record';
    const light=document.createElement('div'); light.className='light '+lightFor(rec);
    const head=document.createElement('div'); head.className='rec-head';
    head.innerHTML=`<div class="rec-title">${rec.cntr}</div><div class="muted">ETD ${rec.etd||'-'}</div><div class="muted">${rec.cliente||''} · ${rec.destino||''}</div>`;
    const right=document.createElement('div'); right.style.marginLeft='auto'; right.innerHTML=`<button class="btn-ghost" data-open="${rec.id}">Abrir</button>`;
    item.appendChild(light); item.appendChild(head); item.appendChild(right);
    list.appendChild(item);
  }
  list.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick=async()=>{ const rec = await getRecord(btn.getAttribute('data-open')); if(rec) loadIntoForm(rec); };
  });
}

/*************** Inicio ***************/
window.addEventListener('load', async ()=>{
  weekOptions($('#weekSelect')); weekOptions($('#f_week')); // SIEMPRE poblar
  currentWeek = new URL(location.href).searchParams.get('wk') || '01';
  $('#weekSelect').value=currentWeek; $('#f_week').value=currentWeek;

  try{ await openDB(); }
  catch(e){ console.warn('IndexedDB no disponible, usando memoria:', e); enableMemory(); }

  refreshList();
});

/*************** Eventos UI ***************/
$('#weekSelect').addEventListener('change', (e)=>{ currentWeek=e.target.value; refreshList(); });
$('#newBtn').onclick = ()=>{ clearForm(); $('#f_week').value=currentWeek; };
$('#newClearBtn').onclick = ()=> clearForm();

$('#saveBtn').onclick = async ()=>{
  const week=$('#f_week').value||currentWeek;
  const cntr=($('#f_cntr').value||'').toUpperCase().trim();
  if(!cntr){ toast('CNTR requerido'); return; }
  const rec={ id: currentId||`${week}:${cntr}`, week, cntr,
    cliente: $('#f_cliente').value.trim(),
    destino: $('#f_destino').value.trim(),
    etd: $('#f_etd').value,
    notas: $('#f_notas').value.trim(),
    ts: Date.now()
  };
  await saveRecord(rec); currentId=rec.id; toast('Guardado ✔'); refreshList();
};

$('#deleteBtn').onclick = async ()=>{
  if(!currentId){ toast('Primero abre/guarda un contenedor'); return; }
  if(confirm('¿Eliminar este contenedor y sus archivos?')){ await deleteRecord(currentId); clearForm(); refreshList(); toast('Eliminado'); }
};

Array.from(document.querySelectorAll('input[type=file][data-file]')).forEach(inp=>{
  inp.addEventListener('change', async (e)=>{
    const files=Array.from(e.target.files||[]); if(!files.length) return;
    const week=$('#f_week').value||currentWeek;
    const cntr=($('#f_cntr').value||'').toUpperCase().trim();
    if(!cntr){ toast('Primero escribe el CNTR'); e.target.value=''; return; }
    const id=currentId||`${week}:${cntr}`;
    if(!currentId){ await saveRecord({id,week,cntr,ts:Date.now()}); currentId=id; }
    const kind=e.target.getAttribute('data-file'); const names=[];
    for(const f of files){ await saveFile(id,kind,f); names.push(f.name); }
    if(kind==='OTROS'){ const otros=await getOtros(id); updateOtrosState(otros.length,otros.map(o=>o.name)); }
    else{ updateDocState(kind,true,'cargado: '+names.join(', ')); }
    toast('Archivo(s) guardados en el dispositivo'); refreshList(); e.target.value='';
  });
});

/*************** Backup / Restore ***************/
$('#exportBtn').onclick = async ()=>{
  const records = useMemory ? [...memRecords.values()] : await new Promise((res,rej)=>{ const out=[]; const req=tx('records').openCursor(); req.onsuccess=(e)=>{const c=e.target.result; if(c){out.push(c.value); c.continue();} else res(out)}; req.onerror=()=>rej(req.error); });
  const files = useMemory ? [...memFiles.values()].map(v=>({...v, dataBase64: arrayBufferToBase64(v.blob)})) :
    await new Promise((res,rej)=>{ const out=[]; const req=tx('files').openCursor(); req.onsuccess=(e)=>{const c=e.target.result; if(c){ const v=c.value; const b64=arrayBufferToBase64(v.blob); out.push({...v,dataBase64:b64}); c.continue(); } else res(out) }; req.onerror=()=>rej(req.error); });
  const payload={version:'1.1', exportedAt:new Date().toISOString(), records, files};
  const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='aconfex_backup.json'; a.click(); URL.revokeObjectURL(a.href);
  toast('Respaldo exportado');
};
$('#importInput').onchange = async (e)=>{
  const file=e.target.files[0]; if(!file) return; const text=await file.text();
  try{
    const data=JSON.parse(text); if(!data||!Array.isArray(data.records)||!Array.isArray(data.files)) throw new Error('Formato inválido');
    if(useMemory){
      memRecords=new Map(data.records.map(r=>[r.id,r]));
      memFiles=new Map(data.files.map(f=>{ const ab=base64ToArrayBuffer(f.dataBase64); const k=f.fileId; return [k,{...f,blob:ab}]; }));
    }else{
      for(const r of data.records){ await new Promise((res,rej)=>{ const req=tx('records','readwrite').put(r); req.onsuccess=res; req.onerror=()=>rej(req.error); }); }
      for(const f of data.files){ const put={...f}; put.blob=base64ToArrayBuffer(f.dataBase64); delete put.dataBase64; await new Promise((res,rej)=>{ const req=tx('files','readwrite').put(put); req.onsuccess=res; req.onerror=()=>rej(req.error); }); }
    }
    toast('Respaldo restaurado'); refreshList();
  }catch(err){ console.error(err); toast('Error al importar'); }
  e.target.value='';
};
function arrayBufferToBase64(buffer){ const bytes=new Uint8Array(buffer); let binary=''; const chunk=0x8000; for(let i=0;i<bytes.length;i+=chunk){ binary+=String.fromCharCode.apply(null, bytes.subarray(i,i+chunk)); } return btoa(binary); }
function base64ToArrayBuffer(b64){ const binary=atob(b64); const len=binary.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes.buffer; }

/*************** Autosave + PDF / Compartir ***************/
async function ensureSavedFromForm(){
  const week=$('#f_week').value||currentWeek;
  const cntr=($('#f_cntr').value||'').toUpperCase().trim();
  if(!cntr){ toast('CNTR requerido'); return null; }
  const rec={ id: currentId||`${week}:${cntr}`, week, cntr,
    cliente: $('#f_cliente').value.trim(),
    destino: $('#f_destino').value.trim(),
    etd: $('#f_etd').value,
    notas: $('#f_notas').value.trim(),
    ts: Date.now()
  };
  await saveRecord(rec); currentId=rec.id; return rec.id;
}

async function buildUnifiedPDF(id){
  const rec = await getRecord(id); if(!rec){ toast('Guarda el contenedor primero'); return null; }
  const files = await getAllFilesFor(id);
  const order = {BL:1, FACT:2, PACKING:3, FITO:4, SEGURO:5, LOGGER:6, OTROS:7};
  files.sort((a,b)=> (order[a.docType]||9) - (order[b.docType]||9) || (a.name||'').localeCompare(b.name||''));

  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const A4_W = 595.28, A4_H = 841.89;

  // helpers
  const drawText = (page, txt, x, y, size=12, color=rgb(0.94,0.98,1)) => page.drawText(String(txt||''), {x, y, size, font, color});
  const drawRect = (page, x,y,w,h,color)=> page.drawRectangle({x,y,width:w,height:h,color});
  const drawLine = (page, x1,y1,x2,y2,color=rgb(0.16,0.24,0.35),width=1) => page.drawLine({start:{x:x1,y:y1}, end:{x:x2,y:y2}, thickness:width, color});
  const drawPill = (page, x,y,w,h,color)=>{ const r=h/2; drawRect(page,x+r,y,w-2*r,h,color); page.drawCircle({x:x+r,y:y+r,size:r,color}); page.drawCircle({x:x+w-r,y:y+r,size:r,color}); };
  const label = (page, txt, x,y) => drawText(page, String(txt).toUpperCase(), x, y, 9, rgb(0.62,0.72,0.86));
  const value = (page, txt, x,y, size=13) => drawText(page, String(txt||''), x, y, size, rgb(0.95,0.98,1));

  // portada
  const page = pdfDoc.addPage([A4_W, A4_H]);
  drawRect(page, 0,0, A4_W, A4_H, rgb(0.06,0.08,0.13));

  const hasBL=files.some(f=>f.docType==='BL'), hasFITO=files.some(f=>f.docType==='FITO'), hasSEGURO=files.some(f=>f.docType==='SEGURO');
  const okCount=[hasBL,hasFITO,hasSEGURO].filter(Boolean).length;
  let status='ROJO', sealColor=rgb(0.94,0.27,0.27); if(okCount===3){status='VERDE';sealColor=rgb(0.13,0.77,0.37);} else if(okCount===2){status='AMARILLO';sealColor=rgb(0.96,0.62,0.04);}

  const M=48;
  drawText(page, 'ACONFEX · Dossier de Contenedor', M, A4_H-72, 28);

  // cápsula OK
  const pillW=330, pillH=36, pillX=A4_W-M-pillW, pillY=A4_H-92; drawPill(page, pillX, pillY, pillW, pillH, sealColor);
  drawText(page, `OK para embarque: ${status}`, pillX+16, pillY+11.5, 13, rgb(0,0,0));

  // panel celdas
  const boxColor = rgb(0.07,0.11,0.18), border = rgb(0.16,0.24,0.35);
  const panelTop = A4_H-180, rowGap=12, colGap=18, cellH=44;
  const panelW = (A4_W - 2*M), cW = (panelW - colGap)/2; const leftX=M, rightX=M+cW+colGap;

  // fila 1
  drawRect(page,leftX,panelTop,cW,cellH,boxColor); drawLine(page,leftX,panelTop,leftX+cW,panelTop,border,1);
  label(page,'Semana',leftX+10,panelTop+cellH-16); value(page,rec.week||'',leftX+10,panelTop+12);
  drawRect(page,rightX,panelTop,cW,cellH,boxColor); drawLine(page,rightX,panelTop,rightX+cW,panelTop,border,1);
  label(page,'CNTR',rightX+10,panelTop+cellH-16); value(page,rec.cntr||'',rightX+10,panelTop+12);

  // fila 2
  const row2Y = panelTop-(cellH+rowGap);
  drawRect(page,leftX,row2Y,cW,cellH,boxColor); label(page,'Cliente',leftX+10,row2Y+cellH-16); value(page,rec.cliente||'',leftX+10,row2Y+12);
  drawRect(page,rightX,row2Y,cW,cellH,boxColor); label(page,'Destino',rightX+10,row2Y+cellH-16); value(page,rec.destino||'', rightX+10,row2Y+12);

  // fila 3
  const row3Y = row2Y-(cellH+rowGap);
  drawRect(page,leftX,row3Y,cW,cellH,boxColor); label(page,'ETD',leftX+10,row3Y+cellH-16); value(page,rec.etd||'',leftX+10,row3Y+12);

  // notas ancho
  const notasX=leftX, notasY=row3Y-(cellH+rowGap), notasW=panelW, notasH=64;
  drawRect(page,notasX,notasY,notasW,notasH,boxColor); label(page,'Notas',notasX+10,notasY+notasH-16);
  const n=(rec.notas||''); const line1=String(n).slice(0,66), line2 = String(n).length>66 ? String(n).slice(66,132) : '';
  value(page,line1,notasX+10,notasY+34); if(line2) value(page,line2,notasX+10,notasY+16);

  // división
  drawLine(page,M,notasY-16,A4_W-M,notasY-16,border,1);

  // incluye + pendientes
  const includeY=notasY-34; drawText(page,'Incluye: BL, Factura, Packing, Fito, Seguro, Logger y Otros.', M, includeY, 11);
  const missing=['BL','FACT','PACKING','FITO','SEGURO','LOGGER'].filter(t=>!files.some(f=>f.docType===t));
  if(missing.length){ drawText(page,'Pendientes: '+missing.join(', '), M, includeY-18, 11, rgb(0.96,0.62,0.04)); }

  // timestamp
  const ts=new Date(); let timeStr; try{ timeStr=ts.toLocaleString('es-CL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }catch{ timeStr=ts.toISOString(); }
  drawText(page, 'Generado: '+timeStr, M, includeY-46, 10);

  // adjuntos
  for(const f of files){
    const bytes=new Uint8Array(f.blob); const type=(f.type||'').toLowerCase();
    try{
      if(type.startsWith('application/pdf')){
        const src=await PDFDocument.load(bytes); const pages=await pdfDoc.copyPages(src, src.getPageIndices()); pages.forEach(p=>pdfDoc.addPage(p));
      } else if(type.startsWith('image/')){
        const pg=pdfDoc.addPage([A4_W, A4_H]); const img= type.includes('png') ? await pdfDoc.embedPng(bytes) : await pdfDoc.embedJpg(bytes);
        const w=img.width,h=img.height,scale=Math.min((A4_W-60)/w,(A4_H-120)/h); const dw=w*scale, dh=h*scale; pg.drawImage(img,{x:(A4_W-dw)/2,y:(A4_H-dh)/2,width:dw,height:dh});
        pg.drawText(`${f.docType||'OTROS'} – ${f.name||''}`.slice(0,80),{x:40,y:40,size:10,font});
      } else if(type.includes('csv')||type.startsWith('text/')){
        const txt=new TextDecoder().decode(bytes).split('\n').slice(0,60).join('\n'); const pg=pdfDoc.addPage([A4_W,A4_H]);
        pg.drawText(`${f.docType||'OTROS'} – ${f.name||''}`.slice(0,90),{x:40,y:A4_H-60,size:12,font});
        let y=A4_H-90; const size=10; for(const line of txt.split('\n')){ pg.drawText(line.slice(0,110),{x:40,y,size,font}); y-=size+4; if(y<60) break; }
      } else {
        const pg=pdfDoc.addPage([A4_W,A4_H]); pg.drawText(`Adjunto no visualizable: ${f.name||''}`.slice(0,90),{x:40,y:A4_H-60,size:12,font});
      }
    }catch(err){ console.warn('Error adjunto', f.name, err); }
  }

  const pdfBytes=await pdfDoc.save();
  const blob=new Blob([pdfBytes],{type:'application/pdf'});
  const filename=`${rec.week||'SEM'}_${rec.cntr||'CNTR'}_dossier.pdf`;
  return {blob, filename};
}

$('#pdfBtn').onclick = async ()=>{
  const id=await ensureSavedFromForm(); if(!id) return;
  const built=await buildUnifiedPDF(id); if(!built) return;
  const a=document.createElement('a'); a.href=URL.createObjectURL(built.blob); a.download=built.filename; a.click(); URL.revokeObjectURL(a.href);
};
$('#shareBtn').onclick = async ()=>{
  const id=await ensureSavedFromForm(); if(!id) return;
  const built=await buildUnifiedPDF(id); if(!built) return;
  try{
    const file=new File([built.blob], built.filename, {type:'application/pdf'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title: built.filename, text: `Dossier de contenedor ${id.split(':')[1]}`});
    }else{
      const a=document.createElement('a'); a.href=URL.createObjectURL(built.blob); a.download=built.filename; a.click(); URL.revokeObjectURL(a.href);
      toast('Compartir no soportado – se descargó el PDF');
    }
  }catch(err){ console.error(err); toast('No se pudo compartir'); }
};
</script>

<!-- Service Worker (opcional) -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js?v=v6').catch(console.error);
  navigator.serviceWorker.addEventListener('message', (e)=>{
    if(e.data && e.data.type==='SW_ACTIVATED'){
      const t=document.getElementById('toast'); if(t){ t.textContent='App actualizada. Recargando…'; t.style.display='block'; }
      setTimeout(()=>location.reload(), 800);
    }
  });
}
</script>
</body>
</html>
