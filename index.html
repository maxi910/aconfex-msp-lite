<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACONFEX · MSP ULTRA‑LITE</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#38bdf8;
      --border:#1f2937; --chip:#0b3b54;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1000px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:18px;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:12px}

    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns: 370px 1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a1324;color:var(--text);font-size:14px}
    input[type=date]{color-scheme:dark}
    textarea{min-height:88px;resize:vertical}
    button{cursor:pointer;border-color:#0b2440;background:#0b2440}
    button:hover{background:#0c3055}
    .row{display:flex;gap:10px}
    .row>*{flex:1}

    .docs{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.docs{grid-template-columns:1fr 1fr}}
    .docbox{border:1px dashed #27445f;border-radius:12px;padding:10px;background:#0b162a}
    .dochead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .docname{font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;color:#bfeaff}
    .chip.ok{background:rgba(34,197,94,.15);color:#bbf7d0}
    .chip.miss{background:rgba(239,68,68,.15);color:#fecaca}

    .list-empty{border:1px dashed #234; border-radius:12px;padding:12px;color:#9fb3c8;background:#0b162a}

    .record{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0a1324}
    .light{width:12px;height:12px;border-radius:999px}
    .light.green{background:var(--ok)}
    .light.yellow{background:var(--warn)}
    .light.red{background:var(--bad)}
    .rec-head{display:flex;gap:8px;flex-wrap:wrap}
    .rec-title{font-weight:700}
    .muted{color:var(--muted)}
    .actions{margin-top:8px;display:flex;gap:8px}
    .btn-ghost{background:#091125;border-color:#1a2c48}

    .help{font-size:12px;color:#a8c1d9}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#081122;border:1px solid #263850;border-radius:6px;padding:1px 6px}

    .footer{color:#92a7be;font-size:12px;margin-top:4px}

    .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#0b2a3f;color:#d8f0ff;border:1px solid #1d4763;padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h1>ACONFEX · MSP ULTRA‑LITE</h1>
        <div class="subtitle">Una sola página, datos guardados en tu teléfono (sin servidores)</div>
      </div>
      <div class="row" style="min-width:280px">
        <select id="weekSelect"></select>
        <button id="newBtn" title="Nuevo contenedor">+ Nuevo</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Formulario -->
    <section class="card" id="formCard">
      <h3 style="margin:0 0 10px">Contenedor</h3>
      <div class="row">
        <div>
          <label>Semana</label>
          <select id="f_week"></select>
        </div>
        <div>
          <label>CNTR (ej. MAEU1234567)</label>
          <input id="f_cntr" placeholder="MAEU1234567" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Cliente</label>
          <input id="f_cliente" placeholder="Cliente" />
        </div>
        <div>
          <label>Destino</label>
          <input id="f_destino" placeholder="Ciudad/País" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>ETD (salida)</label>
          <input id="f_etd" type="date" />
        </div>
        <div>
          <label>Notas</label>
          <input id="f_notas" placeholder="Notas breves" />
        </div>
      </div>

      <label style="margin-top:12px">Documentos (PDF/Imagen)</label>
      <div class="docs">
        <div class="docbox" data-doctype="BL">
          <div class="dochead"><span class="docname">BL</span><span class="chip miss" id="state_BL">faltante</span></div>
          <input type="file" accept="application/pdf,image/*" data-file="BL" />
          <div class="help" id="info_BL"></div>
        </div>
        <div class="docbox" data-doctype="PACKING">
          <div class="dochead"><span class="docname">Packing List</span><span class="chip miss" id="state_PACKING">faltante</span></div>
          <input type="file" accept="application/pdf,image/*" data-file="PACKING" />
          <div class="help" id="info_PACKING"></div>
        </div>
        <div class="docbox" data-doctype="FITO">
          <div class="dochead"><span class="docname">Fitosanitario</span><span class="chip miss" id="state_FITO">faltante</span></div>
          <input type="file" accept="application/pdf,image/*" data-file="FITO" />
          <div class="help" id="info_FITO"></div>
        </div>
        <div class="docbox" data-doctype="SEGURO">
          <div class="dochead"><span class="docname">Seguro</span><span class="chip miss" id="state_SEGURO">faltante</span></div>
          <input type="file" accept="application/pdf,image/*" data-file="SEGURO" />
          <div class="help" id="info_SEGURO"></div>
        </div>
        <div class="docbox" data-doctype="VGM">
          <div class="dochead"><span class="docname">VGM <span class="muted" title="Verified Gross Mass">(masa bruta verificada)</span></span><span class="chip miss" id="state_VGM">faltante</span></div>
          <input type="file" accept="application/pdf,image/*" data-file="VGM" />
          <div class="help">El <b>VGM</b> (Verified Gross Mass) es la masa bruta verificada exigida por SOLAS para embarcar: peso carga + embalaje + contenedor.</div>
        </div>
        <div class="docbox" data-doctype="LOGGER">
          <div class="dochead"><span class="docname">Datalogger / Temperatura</span><span class="chip miss" id="state_LOGGER">faltante</span></div>
          <input type="file" accept="application/pdf,image/*,.csv" data-file="LOGGER" />
          <div class="help" id="info_LOGGER"></div>
        </div>
        <div class="docbox" data-doctype="OTROS">
          <div class="dochead"><span class="docname">Otros (PDF/PNG/JPG)</span><span class="chip" id="state_OTROS">0 adjuntos</span></div>
          <input type="file" accept="application/pdf,image/*" multiple data-file="OTROS" />
          <div class="help" id="info_OTROS"></div>
        </div>
      </div>

      <div class="actions">
        <button id="saveBtn">Guardar</button>
        <button id="newClearBtn" class="btn-ghost">Limpiar</button>
        <button id="deleteBtn" class="btn-ghost">Eliminar</button>
      </div>
      <div class="footer">Los documentos se guardan <b>localmente</b> en tu dispositivo (IndexedDB). No se suben a ningún servidor.</div>
    </section>

    <!-- Lista por semana -->
    <section class="card">
      <h3 style="margin:0 0 10px">Semana <span id="wkTitle">01</span> · Contenedores</h3>
      <div id="list"></div>
      <div id="empty" class="list-empty" style="display:none">Aún no hay contenedores esta semana. Pulsa <span class="kbd">+ Nuevo</span> para crear uno.</div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

<script>
/*****************
 * IndexedDB lite
 *****************/
const DB_NAME = 'aconfexDB';
const DB_VER  = 1;
let db;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains('records')){
        d.createObjectStore('records', {keyPath:'id'});
      }
      if(!d.objectStoreNames.contains('files')){
        d.createObjectStore('files', {keyPath:'fileId'}); // fileId = id:DOCTYPE or id:OTROS:timestamp
      }
    };
    req.onsuccess = ()=>{ db=req.result; resolve(); };
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store,mode='readonly'){ return db.transaction(store, mode).objectStore(store); }

async function saveRecord(rec){
  await new Promise((res,rej)=>{ const r = tx('records','readwrite').put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error); });
}
async function getRecord(id){
  return await new Promise((res,rej)=>{ const r = tx('records').get(id); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
}
async function deleteRecord(id){
  await new Promise((res,rej)=>{ const r = tx('records','readwrite').delete(id); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  // borrar ficheros asociados
  const all = await getAllFilesFor(id);
  for(const f of all){ await new Promise((res,rej)=>{ const r=tx('files','readwrite').delete(f.fileId); r.onsuccess=res; r.onerror=()=>rej(r.error); }); }
}
async function getWeekRecords(week){
  return await new Promise((res,rej)=>{
    const out=[]; const store = tx('records'); const req = store.openCursor();
    req.onsuccess = (e)=>{ const cur = e.target.result; if(cur){ if(String(cur.value.week)===String(week)) out.push(cur.value); cur.continue(); } else res(out.sort((a,b)=>a.cntr.localeCompare(b.cntr))); };
    req.onerror = ()=>rej(req.error);
  });
}

async function saveFile(id, docType, file){
  const isOtros = docType==='OTROS';
  const key = isOtros ? `${id}:OTROS:${Date.now()}:${file.name}` : `${id}:${docType}`;
  const payload = {fileId:key, id, docType, name:file.name, type:file.type, ts:Date.now()};
  payload.blob = await file.arrayBuffer(); // almacenamos ArrayBuffer
  await new Promise((res,rej)=>{ const r = tx('files','readwrite').put(payload); r.onsuccess=res; r.onerror=()=>rej(r.error); });
}
async function getFile(id,docType){
  return await new Promise((res,rej)=>{ const r=tx('files').get(`${id}:${docType}`); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
}
async function getOtros(id){
  return await new Promise((res,rej)=>{
    const out=[]; const store=tx('files'); const req=store.openCursor();
    req.onsuccess=(e)=>{ const cur=e.target.result; if(cur){ const v=cur.value; if(v.id===id && v.docType==='OTROS') out.push(v); cur.continue(); } else res(out); };
    req.onerror=()=>rej(req.error);
  });
}
async function getAllFilesFor(id){
  return await new Promise((res,rej)=>{
    const out=[]; const store=tx('files'); const req=store.openCursor();
    req.onsuccess=(e)=>{ const cur=e.target.result; if(cur){ if(cur.value.id===id) out.push(cur.value); cur.continue(); } else res(out); };
    req.onerror=()=>rej(req.error);
  });
}

/*****************
 * UI helpers
 *****************/
const $ = (q)=>document.querySelector(q);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
function weekOptions(sel){ sel.innerHTML=''; for(let i=1;i<=35;i++){ const op=document.createElement('option'); op.value=String(i).padStart(2,'0'); op.textContent='Semana '+String(i).padStart(2,'0'); sel.appendChild(op);} }

function lightFor(rec){
  const hasBL=!!rec.files.BL; const hasFITO=!!rec.files.FITO; const hasSEGURO=!!rec.files.SEGURO; const hasVGM=!!rec.files.VGM;
  const critical = [hasBL,hasFITO,hasSEGURO,hasVGM].filter(Boolean).length;
  if(critical>=4) return 'green';
  if(critical>=2) return 'yellow';
  return 'red';
}

function idFrom(rec){ return `${rec.week}:${rec.cntr.toUpperCase()}`; }

/*****************
 * State
 *****************/
let currentWeek = '01';
let currentId = null;

async function refreshList(){
  const list=$('#list'); list.innerHTML='';
  const data = await getWeekRecords(currentWeek);
  if(!data.length){ $('#empty').style.display='block'; $('#wkTitle').textContent=currentWeek; return; }
  $('#empty').style.display='none'; $('#wkTitle').textContent=currentWeek;
  for(const r of data){
    const rec = await inflateRecord(r);
    const item = document.createElement('div'); item.className='record';
    const light = document.createElement('div'); light.className='light '+lightFor(rec);
    const head = document.createElement('div'); head.className='rec-head';
    head.innerHTML = `<div class="rec-title">${rec.cntr}</div><div class="muted">ETD ${rec.etd||'-'}</div><div class="muted">${rec.cliente||''} · ${rec.destino||''}</div>`;
    const right = document.createElement('div'); right.style.marginLeft='auto'; right.innerHTML = `<button class="btn-ghost" data-open="${rec.id}">Abrir</button>`;
    item.appendChild(light); item.appendChild(head); item.appendChild(right);
    list.appendChild(item);
  }
  // wire open
  list.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = async()=>{ const id=btn.getAttribute('data-open'); const rec = await getRecord(id); loadIntoForm(rec); };
  });
}

async function inflateRecord(base){
  const id=base.id; const files={};
  for(const k of ['BL','PACKING','FITO','SEGURO','VGM','LOGGER']){
    const f = await getFile(id,k); files[k]=!!f; }
  const otros = await getOtros(id); files.OTROS = otros.length;
  return {...base, files};
}

function clearForm(){ currentId=null; $('#f_cntr').value=''; $('#f_cliente').value=''; $('#f_destino').value=''; $('#f_etd').value=''; $('#f_notas').value='';
  for(const k of ['BL','PACKING','FITO','SEGURO','VGM','LOGGER']) updateDocState(k,false,'');
  updateOtrosState(0,[]);
}

function loadIntoForm(rec){
  currentId = rec.id; $('#f_week').value = rec.week; $('#f_cntr').value = rec.cntr; $('#f_cliente').value=rec.cliente||''; $('#f_destino').value=rec.destino||''; $('#f_etd').value=rec.etd||''; $('#f_notas').value=rec.notas||'';
  // refresh file chips
  inflateRecord(rec).then(r=>{
    for(const k of ['BL','PACKING','FITO','SEGURO','VGM','LOGGER']) updateDocState(k, r.files[k], r.files[k]?'cargado':'' );
    updateOtrosState(r.files.OTROS, []);
  });
}

function updateDocState(k, ok, info){
  const chip = document.getElementById('state_'+k); if(!chip) return;
  chip.textContent = ok? 'cargado' : 'faltante'; chip.className = 'chip ' + (ok? 'ok':'miss');
  const inf = document.getElementById('info_'+k); if(inf) inf.textContent = info||'';
}
function updateOtrosState(n, names){
  const chip = document.getElementById('state_OTROS'); chip.textContent = (n||0)+ ' adjuntos';
  const inf = document.getElementById('info_OTROS'); if(names && names.length) inf.textContent = names.join(', ');
}

/*****************
 * Events
 *****************/
window.addEventListener('load', async ()=>{
  await openDB();
  // semanas
  weekOptions(document.getElementById('weekSelect'));
  weekOptions(document.getElementById('f_week'));
  currentWeek = new URL(location.href).searchParams.get('wk') || '01';
  document.getElementById('weekSelect').value = currentWeek;
  document.getElementById('f_week').value = currentWeek;
  refreshList();
});

// cambiar semana
document.getElementById('weekSelect').addEventListener('change', (e)=>{ currentWeek = e.target.value; refreshList(); });

// nuevo
document.getElementById('newBtn').onclick = ()=>{ clearForm(); document.getElementById('f_week').value=currentWeek; };

document.getElementById('newClearBtn').onclick = ()=> clearForm();

// guardar
document.getElementById('saveBtn').onclick = async ()=>{
  const week = document.getElementById('f_week').value || currentWeek;
  const cntr = (document.getElementById('f_cntr').value||'').toUpperCase().trim();
  if(!cntr){ toast('CNTR requerido'); return; }
  const rec = {
    id: currentId || `${week}:${cntr}`,
    week, cntr,
    cliente: document.getElementById('f_cliente').value.trim(),
    destino: document.getElementById('f_destino').value.trim(),
    etd: document.getElementById('f_etd').value,
    notas: document.getElementById('f_notas').value.trim(),
    ts: Date.now()
  };
  await saveRecord(rec); currentId = rec.id; toast('Guardado ✔'); refreshList();
};

// eliminar
document.getElementById('deleteBtn').onclick = async ()=>{
  if(!currentId){ toast('Primero abre/guarda un contenedor'); return; }
  if(confirm('¿Eliminar este contenedor y sus archivos?')){ await deleteRecord(currentId); clearForm(); refreshList(); toast('Eliminado'); }
};

// inputs de archivos
Array.from(document.querySelectorAll('input[type=file][data-file]')).forEach(inp=>{
  inp.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]); if(!files.length) return;
    // asegurar record
    const week = document.getElementById('f_week').value || currentWeek;
    const cntr = (document.getElementById('f_cntr').value||'').toUpperCase().trim();
    if(!cntr){ toast('Primero escribe el CNTR'); e.target.value=''; return; }
    const id = currentId || `${week}:${cntr}`;
    if(!currentId){ await saveRecord({id,week,cntr,ts:Date.now()}); currentId=id; }

    const kind = e.target.getAttribute('data-file');
    const names=[];
    for(const f of files){ await saveFile(id, kind, f); names.push(f.name); }

    if(kind==='OTROS'){
      const otros = await getOtros(id); updateOtrosState(otros.length, otros.map(o=>o.name));
    } else {
      updateDocState(kind,true,'cargado: '+names.join(', '));
    }

    toast('Archivo(s) guardados en el dispositivo'); refreshList(); e.target.value='';
  });
});
</script>
</body>
</html>
