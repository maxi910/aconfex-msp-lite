<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ACONFEX · MSP </title>
<meta name="theme-color" content="#0f172a" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-180.png">
<style>
:root{
  --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#38bdf8;
  --border:#1f2937; --chip:#0b3b54;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.wrap{max-width:1000px;margin:0 auto;padding:14px}
h1{margin:0;font-size:18px;letter-spacing:.3px}
.subtitle{color:var(--muted);font-size:12px}
.grid{display:grid;gap:14px}
@media(min-width:900px){.grid{grid-template-columns:370px 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a1324;color:var(--text);font-size:14px}
input[type=date]{color-scheme:dark}
textarea{min-height:88px;resize:vertical}
button{cursor:pointer;border-color:#0b2440;background:#0b2440}
button:hover{background:#0c3055}
.row{display:flex;gap:10px}.row>*{flex:1}
.docs{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){.docs{grid-template-columns:1fr 1fr}}
.docbox{border:1px dashed #27445f;border-radius:12px;padding:10px;background:#0b162a}
.dochead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.docname{font-weight:600}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;color:#bfeaff}
.chip.ok{background:rgba(34,197,94,.15);color:#bbf7d0}
.chip.ok::before{content:"✓ ";font-weight:700}
.chip.miss{background:rgba(239,68,68,.15);color:#fecaca}
.list-empty{border:1px dashed #234;border-radius:12px;padding:12px;color:#9fb3c8;background:#0b162a}
.record{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0a1324}
.light{width:12px;height:12px;border-radius:999px}
.light.green{background:var(--ok)}.light.yellow{background:var(--warn)}.light.red{background:var(--bad)}
.rec-head{display:flex;gap:8px;flex-wrap:wrap}
.rec-title{font-weight:700}
.muted{color:var(--muted)}
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-ghost{background:#091125;border-color:#1a2c48}
.btn-mini{width:auto;display:inline-flex;gap:6px;align-items:center;padding:6px 10px;font-size:12px;border-radius:8px}
.btn-danger{background:#3a0d0d;border-color:#4a1515}
.btn-danger:hover{background:#531616}
.btn-mini[disabled]{opacity:.55;cursor:not-allowed}
.help{font-size:12px;color:#a8c1d9}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#081122;border:1px solid #263850;border-radius:6px;padding:1px 6px}
.footer{color:#92a7be;font-size:12px;margin-top:4px}
.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#0b2a3f;color:#d8f0ff;border:1px solid #1d4763;padding:10px 14px;border-radius:10px;display:none}

/* Lista OTROS */
.otros-list{margin-top:6px;display:flex;flex-direction:column;gap:6px}
.adj-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);background:#0a1324;border-radius:8px;padding:6px 8px}
.adj-name{font-size:12px;color:#cdd9e5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:62%}
.adj-actions .btn-mini{margin-left:6px}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div>
      <h1>ACONFEX · DOCUMENTACION MSP</h1>
      <div class="subtitle">Datos guardados en tu teléfono (sin servidores)</div>
    </div>
    <div class="row" style="min-width:320px;align-items:center">
      <label for="weekSelect" class="muted" style="min-width:120px">Semana (vista)</label>
      <select id="weekSelect" title="Filtra la lista por semana"></select>
      <button id="newBtn" title="Nuevo contenedor">+ Nuevo</button>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- Formulario -->
  <section class="card" id="formCard">
    <h3 style="margin:0 0 10px">Contenedor</h3>
    <div class="row">
      <div>
        <label>Semana (del contenedor)</label>
        <select id="f_week"></select>
      </div>
      <div>
        <label>CNTR (ej. MAEU1234567)</label>
        <input id="f_cntr" placeholder="MAEU1234567" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Cliente</label>
        <input id="f_cliente" placeholder="Cliente" />
      </div>
      <div>
        <label>Destino</label>
        <input id="f_destino" placeholder="Ciudad/País" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>ETD (salida)</label>
        <input id="f_etd" type="date" />
      </div>
      <div>
        <label>Notas</label>
        <input id="f_notas" placeholder="Notas breves" />
      </div>
    </div>

    <label style="margin-top:12px">Documentos (PDF/Imagen)</label>
    <div class="docs">
      <div class="docbox" data-doctype="BL">
        <div class="dochead">
          <span class="docname">BL</span>
          <span class="chip miss" id="state_BL">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*" data-file="BL" />
        <div class="help" id="info_BL"></div>
        <div class="actions">
          <button class="btn-mini" data-view="BL" disabled>Ver BL</button>
          <button class="btn-mini btn-danger" data-del="BL" disabled>Eliminar BL</button>
        </div>
      </div>

      <div class="docbox" data-doctype="FACT">
        <div class="dochead">
          <span class="docname">Factura (Invoice)</span>
          <span class="chip miss" id="state_FACT">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*" data-file="FACT" />
        <div class="help" id="info_FACT"></div>
        <div class="actions">
          <button class="btn-mini" data-view="FACT" disabled>Ver Factura</button>
          <button class="btn-mini btn-danger" data-del="FACT" disabled>Eliminar Factura</button>
        </div>
      </div>

      <div class="docbox" data-doctype="PACKING">
        <div class="dochead">
          <span class="docname">Packing List</span>
          <span class="chip miss" id="state_PACKING">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*" data-file="PACKING" />
        <div class="help" id="info_PACKING"></div>
        <div class="actions">
          <button class="btn-mini" data-view="PACKING" disabled>Ver Packing</button>
          <button class="btn-mini btn-danger" data-del="PACKING" disabled>Eliminar Packing</button>
        </div>
      </div>

      <div class="docbox" data-doctype="FITO">
        <div class="dochead">
          <span class="docname">Fitosanitario</span>
          <span class="chip miss" id="state_FITO">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*" data-file="FITO" />
        <div class="help" id="info_FITO"></div>
        <div class="actions">
          <button class="btn-mini" data-view="FITO" disabled>Ver Fito</button>
          <button class="btn-mini btn-danger" data-del="FITO" disabled>Eliminar Fito</button>
        </div>
      </div>

      <div class="docbox" data-doctype="SEGURO">
        <div class="dochead">
          <span class="docname">Seguro</span>
          <span class="chip miss" id="state_SEGURO">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*" data-file="SEGURO" />
        <div class="help" id="info_SEGURO"></div>
        <div class="actions">
          <button class="btn-mini" data-view="SEGURO" disabled>Ver Seguro</button>
          <button class="btn-mini btn-danger" data-del="SEGURO" disabled>Eliminar Seguro</button>
        </div>
      </div>

      <div class="docbox" data-doctype="LOGGER">
        <div class="dochead">
          <span class="docname">Datalogger / Temperatura</span>
          <span class="chip miss" id="state_LOGGER">faltante</span>
        </div>
        <input type="file" accept="application/pdf,image/*,.csv" data-file="LOGGER" />
        <div class="help" id="info_LOGGER"></div>
        <div class="actions">
          <button class="btn-mini" data-view="LOGGER" disabled>Ver Logger</button>
          <button class="btn-mini btn-danger" data-del="LOGGER" disabled>Eliminar Logger</button>
        </div>
      </div>

      <!-- OTROS (con VER/ELIMINAR por archivo) -->
      <div class="docbox" data-doctype="OTROS">
        <div class="dochead">
          <span class="docname">Otros (PDF/PNG/JPG)</span>
          <span class="chip" id="state_OTROS">0 adjuntos</span>
        </div>
        <input type="file" accept="application/pdf,image/*" multiple data-file="OTROS" />
        <div class="help" id="info_OTROS"></div>
        <!-- Lista dinámica de adjuntos con botones "Ver" y "Eliminar" -->
        <div id="otrosList" class="otros-list"><div class="help">Sin adjuntos</div></div>
      </div>
    </div>

    <div class="actions">
      <button id="saveBtn">Guardar</button>
      <button id="pdfBtn">PDF unificado</button>
      <button id="shareBtn">Compartir PDF</button>
      <button id="newClearBtn" class="btn-ghost">Limpiar</button>
      <button id="deleteBtn" class="btn-ghost">Eliminar</button>
    </div>

    <div class="footer">Los documentos se guardan <b>localmente</b> en tu dispositivo (IndexedDB). No se suben a ningún servidor.</div>

    <div class="actions" style="margin-top:12px">
      <button id="exportBtn" class="btn-ghost">Respaldar (Exportar JSON)</button>
      <label for="importInput" class="btn-ghost" style="display:inline-block;text-align:center;cursor:pointer">Restaurar (Importar JSON)</label>
      <input id="importInput" type="file" accept="application/json" style="display:none" />
    </div>
  </section>

  <!-- Lista por semana -->
  <section class="card">
    <h3 style="margin:0 0 10px">Semana <span id="wkTitle">01</span> · Contenedores</h3>
    <div id="list"></div>
    <div id="empty" class="list-empty" style="display:none">Aún no hay contenedores esta semana. Pulsa <span class="kbd">+ Nuevo</span> para crear uno.</div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
/* ------------- Utils ------------- */
const $ = (q)=>document.querySelector(q);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }
function weekOptions(sel){ sel.innerHTML=''; for(let i=1;i<=52;i++){ const op=document.createElement('option'); op.value=String(i).padStart(2,'0'); op.textContent='Semana '+String(i).padStart(2,'0'); sel.appendChild(op);} }

/* ------------- IndexedDB (con fallback memoria) ------------- */
let db=null, useMemory=false;
let memRecords=new Map(), memFiles=new Map();

function openDB(){
  return new Promise((resolve,reject)=>{
    if(!('indexedDB' in window)) return reject(new Error('IndexedDB no soportado'));
    const req = indexedDB.open('aconfexDB', 1);
    req.onupgradeneeded = (e)=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('records')) d.createObjectStore('records',{keyPath:'id'});
      if(!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'fileId'});
    };
    req.onsuccess = ()=>{ db=req.result; resolve(); };
    req.onerror = ()=>reject(req.error);
  });
}
function tx(name,mode='readonly'){ return db.transaction(name,mode).objectStore(name); }

let saveRecord = async (rec)=>{ await new Promise((res,rej)=>{ const r=tx('records','readwrite').put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error); }); };
let getRecord  = async (id)=> await new Promise((res,rej)=>{ const r=tx('records').get(id); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
let deleteRecord = async (id)=>{ await new Promise((res,rej)=>{ const r=tx('records','readwrite').delete(id); r.onsuccess=res; r.onerror=()=>rej(r.error); }); const all=await getAllFilesFor(id); for(const f of all){ await new Promise((res,rej)=>{ const r=tx('files','readwrite').delete(f.fileId); r.onsuccess=res; r.onerror=()=>rej(r.error); }); } };
let getWeekRecords = async (week)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('records').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ if(String(c.value.week)===String(week)) out.push(c.value); c.continue(); } else res(out.sort((a,b)=>a.cntr.localeCompare(b.cntr))); }; req.onerror=()=>rej(req.error); });
let saveFile = async (id,docType,file)=>{ const key=(docType==='OTROS')?`${id}:OTROS:${Date.now()}:${file.name}`:`${id}:${docType}`; const payload={fileId:key,id,docType,name:file.name,type:file.type,ts:Date.now()}; payload.blob=await file.arrayBuffer(); await new Promise((res,rej)=>{ const r=tx('files','readwrite').put(payload); r.onsuccess=res; r.onerror=()=>rej(r.error); }); };
let getFile  = async (id,docType)=> await new Promise((res,rej)=>{ const r=tx('files').get(`${id}:${docType}`); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
let getOtros = async (id)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('files').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ const v=c.value; if(v.id===id && v.docType==='OTROS') out.push(v); c.continue(); } else res(out); }; req.onerror=()=>rej(req.error); });
let getAllFilesFor = async (id)=> await new Promise((res,rej)=>{ const out=[]; const req=tx('files').openCursor(); req.onsuccess=(e)=>{ const c=e.target.result; if(c){ if(c.value.id===id) out.push(c.value); c.continue(); } else res(out); }; req.onerror=()=>rej(req.error); });

function enableMemory(){
  useMemory=true;
  saveRecord = async (rec)=>{ memRecords.set(rec.id, rec); };
  getRecord  = async (id)=> memRecords.get(id)||null;
  deleteRecord = async (id)=>{ memRecords.delete(id); for (const k of [...memFiles.keys()]) if(k.startsWith(id+':')) memFiles.delete(k); };
  getWeekRecords = async (w)=> [...memRecords.values()].filter(r=>String(r.week)===String(w)).sort((a,b)=>a.cntr.localeCompare(b.cntr));
  saveFile = async (id,docType,file)=>{ const key=(docType==='OTROS')?`${id}:OTROS:${Date.now()}:${file.name}`:`${id}:${docType}`; const ab=await file.arrayBuffer(); memFiles.set(key,{fileId:key,id,docType,name:file.name,type:file.type,ts:Date.now(),blob:ab}); };
  getFile = async (id,docType)=> memFiles.get(`${id}:${docType}`)||null;
  getOtros = async (id)=> [...memFiles.values()].filter(v=>v.id===id && v.docType==='OTROS');
  getAllFilesFor = async (id)=> [...memFiles.values()].filter(v=>v.id===id);
}

/* ------------- Estado/UI ------------- */
const SINGLE_DOCS = ['BL','FACT','PACKING','FITO','SEGURO','LOGGER'];
function lightFor(rec){ const n=[rec.files.BL,rec.files.FITO,rec.files.SEGURO].filter(Boolean).length; return n>=3?'green':(n>=2?'yellow':'red'); }
let currentWeek='01', currentId=null;

async function inflateRecord(base){
  const id=base.id, files={};
  for(const k of SINGLE_DOCS){ files[k] = !!(await getFile(id,k)); }
  files.OTROS = (await getOtros(id)).length;
  return {...base, files};
}
function setDelEnabled(k, on){ const b=document.querySelector(`button[data-del="${k}"]`); if(b) b.disabled=!on; }
function setViewEnabled(k, on){ const b=document.querySelector(`button[data-view="${k}"]`); if(b) b.disabled=!on; }
function updateDocState(k, ok, info){
  const chip=$('#state_'+k); if(!chip) return;
  chip.className='chip '+(ok?'ok':'miss'); chip.textContent = ok?'cargado':'faltante';
  const inf=$('#info_'+k); if(inf) inf.textContent = info||'';
  if(SINGLE_DOCS.includes(k)){ setDelEnabled(k,!!ok); setViewEnabled(k,!!ok); }
}
function updateOtrosState(n, names){
  const chip=$('#state_OTROS'); if(n>0){ chip.className='chip ok'; chip.textContent=n+' adjuntos'; } else { chip.className='chip'; chip.textContent='0 adjuntos'; }
  const inf=$('#info_OTROS'); if(inf) inf.textContent = names?.join(', ') || '';
}
function clearForm(){
  currentId=null; ['f_cntr','f_cliente','f_destino','f_etd','f_notas'].forEach(id=>$('#'+id).value='');
  for(const k of SINGLE_DOCS) updateDocState(k,false,''); updateOtrosState(0,[]);
  $('#otrosList').innerHTML='<div class="help">Sin adjuntos</div>';
}
function loadIntoForm(rec){
  currentId=rec.id; $('#f_week').value=rec.week; $('#f_cntr').value=rec.cntr; $('#f_cliente').value=rec.cliente||''; $('#f_destino').value=rec.destino||''; $('#f_etd').value=rec.etd||''; $('#f_notas').value=rec.notas||'';
  inflateRecord(rec).then(r=>{ for(const k of SINGLE_DOCS) updateDocState(k,r.files[k],r.files[k]?'cargado':''); updateOtrosState(r.files.OTROS,[]); });
  refreshOtrosList();
}
async function refreshList(){
  const list=$('#list'); list.innerHTML='';
  const data=await getWeekRecords(currentWeek);
  if(!data.length){ $('#empty').style.display='block'; $('#wkTitle').textContent=currentWeek; return; }
  $('#empty').style.display='none'; $('#wkTitle').textContent=currentWeek;
  for(const r of data){
    const rec=await inflateRecord(r);
    const el=document.createElement('div'); el.className='record';
    el.innerHTML=`
      <div class="light ${lightFor(rec)}"></div>
      <div class="rec-head">
        <div class="rec-title">${rec.cntr}</div>
        <div class="muted">ETD ${rec.etd||'-'}</div>
        <div class="muted">${rec.cliente||''} · ${rec.destino||''}</div>
      </div>
      <div style="margin-left:auto"><button class="btn-ghost" data-open="${rec.id}">Abrir</button></div>`;
    list.appendChild(el);
  }
  list.querySelectorAll('[data-open]').forEach(b=>b.onclick=async()=>{ const rec=await getRecord(b.dataset.open); if(rec) loadIntoForm(rec); });
}

/* ------------- Inicio ------------- */
window.addEventListener('load', async ()=>{
  weekOptions($('#weekSelect')); weekOptions($('#f_week'));
  currentWeek = new URL(location.href).searchParams.get('wk') || '01';
  $('#weekSelect').value=currentWeek; $('#f_week').value=currentWeek;
  try{ await openDB(); } catch(e){ enableMemory(); }
  refreshList();
});

/* ------------- Eventos formulario ------------- */
$('#weekSelect').addEventListener('change', e=>{ currentWeek=e.target.value; refreshList(); });
$('#newBtn').onclick=()=>{ clearForm(); $('#f_week').value=currentWeek; };
$('#newClearBtn').onclick=()=> clearForm();

$('#saveBtn').onclick=async()=>{
  const week=$('#f_week').value||currentWeek;
  const cntr=($('#f_cntr').value||'').toUpperCase().trim();
  if(!cntr){ toast('CNTR requerido'); return; }
  const rec={ id: currentId||`${week}:${cntr}`, week, cntr,
    cliente: $('#f_cliente').value.trim(), destino: $('#f_destino').value.trim(),
    etd: $('#f_etd').value, notas: $('#f_notas').value.trim(), ts: Date.now()
  };
  await saveRecord(rec); currentId=rec.id; toast('Guardado ✔'); refreshList(); refreshOtrosList();
};

$('#deleteBtn').onclick=async()=>{
  if(!currentId){ toast('Primero abre/guarda un contenedor'); return; }
  if(confirm('¿Eliminar este contenedor y sus archivos?')){ await deleteRecord(currentId); clearForm(); refreshList(); toast('Eliminado'); }
};

/* Subidas (tope=1 salvo OTROS) */
document.querySelectorAll('input[type=file][data-file]').forEach(inp=>{
  inp.addEventListener('change', async(e)=>{
    const files=[...e.target.files||[]]; if(!files.length) return;
    const week=$('#f_week').value||currentWeek;
    const cntr=($('#f_cntr').value||'').toUpperCase().trim();
    if(!cntr){ toast('Primero escribe el CNTR'); e.target.value=''; return; }
    const id=currentId||`${week}:${cntr}`;
    if(!currentId){ await saveRecord({id,week,cntr,ts:Date.now()}); currentId=id; }
    const kind=e.target.dataset.file;

    if(SINGLE_DOCS.includes(kind)){
      const existing=await getFile(id,kind);
      if(existing && !confirm(`Ya existe ${kind}. ¿Reemplazar?`)){ e.target.value=''; return; }
      const f=files[0]; await saveFile(id,kind,f);
      updateDocState(kind,true,'cargado: '+f.name); toast(`${kind} actualizado`);
    }else{ // OTROS (múltiples)
      for(const f of files) await saveFile(id,'OTROS',f);
      const otros=await getOtros(id);
      updateOtrosState(otros.length, otros.map(o=>o.name));
      refreshOtrosList(); toast(`Adjuntos agregados (${files.length})`);
    }
    refreshList(); e.target.value='';
  });
});

/* Eliminar/ver SINGLE_DOCS */
async function deleteSingleFile(kind){
  if(!currentId){ toast('Primero abre/guarda un contenedor'); return; }
  if(!confirm(`¿Eliminar ${kind}?`)) return;
  const key=`${currentId}:${kind}`;
  if(useMemory) memFiles.delete(key);
  else await new Promise((res,rej)=>{ const r=tx('files','readwrite').delete(key); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  updateDocState(kind,false,''); refreshList(); toast(`${kind} eliminado`);
}
document.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>deleteSingleFile(b.dataset.del));

function openBlobInViewer(name,type,buf,label){
  const isPDF=(type||'').includes('pdf')||/\.pdf$/i.test(name||'');
  const isImage=(type||'').startsWith('image/')||/\.(png|jpe?g|gif|webp)$/i.test(name||'');
  const blob=new Blob([buf],{type:isPDF?'application/pdf':(type||'application/octet-stream')});
  const url=URL.createObjectURL(blob);
  let w=null; try{w=window.open('', '_blank');}catch{}
  const html=`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${label} – ${name}</title>
  <style>html,body{height:100%;margin:0;background:#0b1220} .bar{padding:10px 12px;color:#e5e7eb;background:#0f172a;border-bottom:1px solid #1f2937;font:14px system-ui}
  .wrap{height:calc(100% - 44px)} iframe,img{width:100%;height:100%;border:0;background:#0b1220} a{position:fixed;bottom:10px;left:10px;color:#bfeaff;text-decoration:none;font:13px system-ui}</style>
  <div class="bar">${label} · ${name}</div>
  <div class="wrap">${isImage?'<img id="v">':'<iframe id="v"></iframe>'}</div>
  <a id="dl" download="${name}">Descargar</a>`;
  if(w){ w.document.open(); w.document.write(html); w.document.close(); const v=w.document.getElementById('v'); const a=w.document.getElementById('dl'); if(v) v.src=url; if(a) a.href=url; }
  else { const a=document.createElement('a'); a.href=url; a.target='_blank'; a.download=name; a.click(); a.remove(); }
  setTimeout(()=>URL.revokeObjectURL(url),300000);
}
async function viewSingle(kind){
  if(!currentId){ toast('Primero abre/guarda un contenedor'); return; }
  const f=await getFile(currentId,kind); if(!f){ toast(`No hay archivo de ${kind}`); return; }
  openBlobInViewer(f.name,f.type,f.blob,kind);
}
document.querySelectorAll('[data-view]').forEach(b=>b.onclick=()=>viewSingle(b.dataset.view));

/* OTROS: lista con VER/ELIMINAR por item */
async function getFileById(fileId){
  if(useMemory) return memFiles.get(fileId)||null;
  return await new Promise((res,rej)=>{ const r=tx('files').get(fileId); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
}
async function deleteFileById(fileId){
  if(useMemory){ memFiles.delete(fileId); return; }
  await new Promise((res,rej)=>{ const r=tx('files','readwrite').delete(fileId); r.onsuccess=res; r.onerror=()=>rej(r.error); });
}
async function refreshOtrosList(){
  const cont=$('#otrosList'); if(!currentId){ cont.innerHTML='<div class="help">Sin adjuntos</div>'; updateOtrosState(0,[]); return; }
  const items=await getOtros(currentId);
  updateOtrosState(items.length, items.map(o=>o.name));
  if(items.length===0){ cont.innerHTML='<div class="help">Sin adjuntos</div>'; return; }
  cont.innerHTML='';
  items.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  for(const it of items){
    const row=document.createElement('div'); row.className='adj-item';
    row.innerHTML=`<span class="adj-name" title="${it.name}">${it.name}</span>
      <div class="adj-actions">
        <button class="btn-mini" data-view-otros="${it.fileId}">Ver</button>
        <button class="btn-mini btn-danger" data-del-otros="${it.fileId}">Eliminar</button>
      </div>`;
    cont.appendChild(row);
  }
  cont.querySelectorAll('[data-view-otros]').forEach(b=>b.onclick=async()=>{ const f=await getFileById(b.dataset.viewOtros); if(f) openBlobInViewer(f.name,f.type,f.blob,'OTROS'); });
  cont.querySelectorAll('[data-del-otros]').forEach(b=>b.onclick=async()=>{ if(confirm('¿Eliminar adjunto?')){ await deleteFileById(b.dataset.delOtros); refreshOtrosList(); toast('Adjunto eliminado'); }});
}

/* Backup/Restore */
$('#exportBtn').onclick=async()=>{
  const records = useMemory ? [...memRecords.values()] : await new Promise((res,rej)=>{ const out=[]; const c=tx('records').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); });
  const files = useMemory ? [...memFiles.values()].map(v=>({...v,dataBase64:arrayBufferToBase64(v.blob)})) :
    await new Promise((res,rej)=>{ const out=[]; const c=tx('files').openCursor(); c.onsuccess=e=>{ const cur=e.target.result; if(cur){ const v=cur.value; out.push({...v,dataBase64:arrayBufferToBase64(v.blob)}); cur.continue(); } else res(out); }; c.onerror=()=>rej(c.error); });
  const payload={version:'1.3',exportedAt:new Date().toISOString(),records,files};
  const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='aconfex_backup.json'; a.click(); URL.revokeObjectURL(a.href); toast('Respaldo exportado');
};
$('#importInput').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return; const txt=await f.text();
  try{
    const data=JSON.parse(txt);
    if(useMemory){
      memRecords=new Map(data.records.map(r=>[r.id,r]));
      memFiles=new Map(data.files.map(x=>[x.fileId,{...x,blob:base64ToArrayBuffer(x.dataBase64)}]));
    }else{
      for(const r of data.records){ await new Promise((res,rej)=>{ const q=tx('records','readwrite').put(r); q.onsuccess=res; q.onerror=()=>rej(q.error); }); }
      for(const x of data.files){ const put={...x,blob:base64ToArrayBuffer(x.dataBase64)}; delete put.dataBase64; await new Promise((res,rej)=>{ const q=tx('files','readwrite').put(put); q.onsuccess=res; q.onerror=()=>rej(q.error); }); }
    }
    toast('Respaldo restaurado'); refreshList(); refreshOtrosList();
  }catch{ toast('Error al importar'); }
  e.target.value='';
};
function arrayBufferToBase64(buf){ const b=new Uint8Array(buf); let s=''; const ch=0x8000; for(let i=0;i<b.length;i+=ch){ s+=String.fromCharCode.apply(null,b.subarray(i,i+ch)); } return btoa(s); }
function base64ToArrayBuffer(b64){ const bin=atob(b64), len=bin.length, out=new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bin.charCodeAt(i); return out.buffer; }

/* PDF / Compartir (orden: FACT, BL, FITO, SEGURO, PACKING, LOGGER, OTROS) */
async function ensureSavedFromForm(){
  const week=$('#f_week').value||currentWeek;
  const cntr=($('#f_cntr').value||'').toUpperCase().trim();
  if(!cntr){ toast('CNTR requerido'); return null; }
  const rec={ id: currentId||`${week}:${cntr}`, week, cntr,
    cliente: $('#f_cliente').value.trim(), destino: $('#f_destino').value.trim(),
    etd: $('#f_etd').value, notas: $('#f_notas').value.trim(), ts: Date.now()
  };
  await saveRecord(rec); currentId=rec.id; return rec.id;
}
async function buildUnifiedPDF(id){
  const rec=await getRecord(id); if(!rec){ toast('Guarda el contenedor'); return null; }
  const files=await getAllFilesFor(id);
  const order={FACT:1,BL:2,FITO:3,SEGURO:4,PACKING:5,LOGGER:6,OTROS:7};
  files.sort((a,b)=>(order[a.docType]||99)-(order[b.docType]||99)||(a.name||'').localeCompare(b.name||''));

  const {PDFDocument,StandardFonts,rgb}=PDFLib; const pdfDoc=await PDFDocument.create(); const font=await pdfDoc.embedFont(StandardFonts.Helvetica);
  const A4_W=595.28, A4_H=841.89;
  const page=pdfDoc.addPage([A4_W,A4_H]);
  page.drawRectangle({x:0,y:0,width:A4_W,height:A4_H,color:rgb(0.06,0.08,0.13)});
  const draw=(p,t,x,y,s=12,c=rgb(0.94,0.98,1))=>p.drawText(String(t||''),{x,y,size:s,font,color:c});
  const line=(p,x1,y1,x2,y2)=>p.drawLine({start:{x:x1,y:y1},end:{x:x2,y:y2},thickness:1,color:rgb(0.16,0.24,0.35)});
  const pill=(p,x,y,w,h,col)=>{ const r=h/2; p.drawRectangle({x:x+r,y,width:w-2*r,height:h,color:col}); p.drawCircle({x:x+r,y:y+r,size:r,color:col}); p.drawCircle({x:x+w-r,y:y+r,size:r,color:col}); };
  draw(page,'ACONFEX · DOCUMENTACIÓN',48,A4_H-72,28);

  const hasBL=files.some(f=>f.docType==='BL'), hasFITO=files.some(f=>f.docType==='FITO'), hasSEGURO=files.some(f=>f.docType==='SEGURO');
  const n=[hasBL,hasFITO,hasSEGURO].filter(Boolean).length; let status='ROJO', col=rgb(0.94,0.27,0.27); if(n===3){status='VERDE'; col=rgb(0.13,0.77,0.37);} else if(n===2){status='AMARILLO'; col=rgb(0.96,0.62,0.04);}
  const text=`OK para embarque: ${status}`; const w=Math.max(240, font.widthOfTextAtSize(text,13)+48); const x=A4_W-48-w, y=A4_H-120; pill(page,x,y,w,36,col); draw(page,text,x+16,y+11.5,13,rgb(0,0,0));

  const box=rgb(0.07,0.11,0.18); const top=A4_H-180, gap=12, colGap=18, h=44; const panelW=A4_W-96, cW=(panelW-colGap)/2, L=48, R=48+cW+colGap;
  const label=(t,x,y)=>draw(page,String(t).toUpperCase(),x,y,9,rgb(0.62,0.72,0.86));
  const val=(t,x,y,s=13)=>draw(page,String(t||''),x,y,s,rgb(0.95,0.98,1));
  page.drawRectangle({x:L,y:top,width:cW,height:h,color:box}); line(page,L,top,L+cW,top); label('Semana',L+10,top+h-16); val(rec.week,L+10,top+12);
  page.drawRectangle({x:R,y:top,width:cW,height:h,color:box}); line(page,R,top,R+cW,top); label('CNTR',R+10,top+h-16); val(rec.cntr,R+10,top+12);
  const y2=top-(h+gap); page.drawRectangle({x:L,y:y2,width:cW,height:h,color:box}); label('Cliente',L+10,y2+h-16); val(rec.cliente,L+10,y2+12);
  page.drawRectangle({x:R,y:y2,width:cW,height:h,color:box}); label('Destino',R+10,y2+h-16); val(rec.destino,R+10,y2+12);
  const y3=y2-(h+gap); page.drawRectangle({x:L,y:y3,width:cW,height:h,color:box}); label('ETD',L+10,y3+h-16); val(rec.etd,L+10,y3+12);
  const ny=y3-(h+gap); page.drawRectangle({x:L,y:ny,width:panelW,height:64,color:box}); label('Notas',L+10,ny+64-16); const nn=rec.notas||''; val(nn.slice(0,66),L+10,ny+34); if(nn.length>66) val(nn.slice(66,132),L+10,ny+16);
  line(page,48,ny-16,A4_W-48,ny-16); draw(page,'Incluye: Factura, BL, Fito, Seguro, Packing, Logger y Otros.',48,ny-34,11);
  const required=['FACT','BL','FITO','SEGURO','PACKING']; const miss=required.filter(t=>!files.some(f=>f.docType===t)); if(miss.length){ draw(page,'Pendientes: '+miss.join(', '),48,ny-52,11,rgb(0.96,0.62,0.04)); }
  const ts=new Date(); let s; try{s=ts.toLocaleString('es-CL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});}catch{ s=ts.toISOString(); }
  draw(page,'Generado: '+s,48,ny-70,10);

  for(const f of files){
    const bytes=new Uint8Array(f.blob); const type=(f.type||'').toLowerCase();
    try{
      if(type.startsWith('application/pdf')){ const src=await PDFDocument.load(bytes); const pages=await pdfDoc.copyPages(src, src.getPageIndices()); pages.forEach(p=>pdfDoc.addPage(p)); }
      else if(type.startsWith('image/')){ const pg=pdfDoc.addPage([A4_W,A4_H]); const img= type.includes('png')?await pdfDoc.embedPng(bytes):await pdfDoc.embedJpg(bytes); const sc=Math.min((A4_W-60)/img.width,(A4_H-120)/img.height); const dw=img.width*sc, dh=img.height*sc; pg.drawImage(img,{x:(A4_W-dw)/2,y:(A4_H-dh)/2,width:dw,height:dh}); pg.drawText(`${f.docType} – ${f.name}`.slice(0,80),{x:40,y:40,size:10,font}); }
      else if(type.includes('csv')||type.startsWith('text/')){ const txt=new TextDecoder().decode(bytes).split('\n').slice(0,60).join('\n'); const pg=pdfDoc.addPage([A4_W,A4_H]); pg.drawText(`${f.docType} – ${f.name}`.slice(0,90),{x:40,y:A4_H-60,size:12,font}); let y=A4_H-90; for(const ln of txt.split('\n')){ pg.drawText(ln.slice(0,110),{x:40,y,size:10,font}); y-=14; if(y<60) break; } }
      else { const pg=pdfDoc.addPage([A4_W,A4_H]); pg.drawText(`Adjunto no visualizable: ${f.name}`.slice(0,90),{x:40,y:A4_H-60,size:12,font}); }
    }catch{}
  }
  const pdf=await pdfDoc.save(); return { blob:new Blob([pdf],{type:'application/pdf'}), filename:`${rec.week||'SEM'}_${rec.cntr||'CNTR'}_DOCUMENTACION.pdf` };
}
$('#pdfBtn').onclick=async()=>{ const id=await ensureSavedFromForm(); if(!id) return; const out=await buildUnifiedPDF(id); if(!out) return; const a=document.createElement('a'); a.href=URL.createObjectURL(out.blob); a.download=out.filename; a.click(); URL.revokeObjectURL(a.href); };
$('#shareBtn').onclick=async()=>{ const id=await ensureSavedFromForm(); if(!id) return; const out=await buildUnifiedPDF(id); if(!out) return; try{ const file=new File([out.blob],out.filename,{type:'application/pdf'}); if(navigator.canShare && navigator.canShare({files:[file]})) await navigator.share({files:[file],title:out.filename}); else { const a=document.createElement('a'); a.href=URL.createObjectURL(out.blob); a.download=out.filename; a.click(); URL.revokeObjectURL(a.href);} }catch{ toast('No se pudo compartir'); } };
</script>

<!-- SW sin caché estático; cambia ?v=... para forzar actualización -->
<script>
if ('serviceWorker' in navigator) {
  const SW_URL = 'sw.js?v=no-cache-2025-11-08-2';
  navigator.serviceWorker.register(SW_URL).then((reg)=>{
    if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    reg.addEventListener('updatefound', ()=>{
      const nw = reg.installing;
      nw?.addEventListener('statechange', ()=>{
        if (nw.state === 'installed') reg.waiting?.postMessage({type:'SKIP_WAITING'});
      });
    });
  });
  let refreshing=false;
  navigator.serviceWorker.addEventListener('controllerchange', ()=>{
    if (refreshing) return; refreshing=true; location.reload();
  });
}
</script>
</body>
</html>
